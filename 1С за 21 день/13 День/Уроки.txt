День 13. Валовая прибыль. Создание сложных отчетов
  Расчет валовой прибыли и рентабельности 
  Отчёты с несколькими вариантами представления данных
  Диаграммы в отчетах на СДК 
_____________________________________________________________________________________________________________________________________________________________
Расчет валовой прибыли
  Валовая прибыль
    Разница между выручкой и себестоимостью проданного товара
  Проведение документов по регистру "Продажи"
    Учет себестоимости
-------------------------------------------------------------------------------------------------------------------------------------------------------------
МебельДомТорг -> Регистр накопления -> Продажи -> Ресурсы -> Количество, Сумма, Себестоимость
МебельДомТорг -> Документы -> Реализация товаров и услуг -> Прочее -> Модуль объекта ->
Процедура ОбработкаПроведения(Отказ, Режим)
	
	// регистр Взаиморасчеты Приход
	Движения.Взаиморасчеты.Записывать = Истина;
	Движение = Движения.Взаиморасчеты.Добавить();
	Движение.ВидДвижения = ВидДвиженияНакопления.Приход;
	Движение.Период = Дата;
	Движение.Номенклатура = Клиент;
	Движение.Сумма = СуммаДокумента;
	
	// регистр Продажи 
	Движения.Продажи.Записывать = Истина;
	Для Каждого ТекСтрокаТовары Из Товары Цикл
		Движение = Движения.Продажи.Добавить();
		Движение.Период = Дата; 
		Движение.Клиент = Клиент;
		Движение.Номенклатура = ТекСтрокаТовары.Товар; 
		Движение.Количество = ТекСтрокаТовары.Количество;
		Движение.Сумма = ТекСтрокаТовары.Сумма;
	КонецЦикла;
	
	// регистр ТоварыНаСкладах Расход
	Движения.ТоварыНаСкладах.Записывать = Истина;
	Для Каждого ТекСтрокаТовары Из Товары Цикл
		Движение = Движения.ТоварыНаСкладах.Добавить();
		Движение.ВидДвижения = ВидДвиженияНакопления.Расход;
		Движение.Период = Дата;
		Движение.Номенклатура = ТекСтрокаТовары.Товар;
		Движение.Склад = Склад;
		Движение.Количество = ТекСтрокаТовары.Количество;
	КонецЦикла; 
	
	Движения.Записать();
	
	Если Режим = РежимПроведенияДокумента.Оперативный Тогда
	
		Запрос = Новый Запрос;
		Запрос.Текст = 
			"ВЫБРАТЬ
			|	ТоварыНаСкладахОстатки.Номенклатура КАК Номенклатура,
			|	ТоварыНаСкладахОстатки.Склад КАК Склад,
			|	ТоварыНаСкладахОстатки.КоличествоОстаток КАК Количество
			|ИЗ
			|	РегистрНакопления.ТоварыНаСкладах.Остатки(
			|			,
			|			Склад = &Склад
			|				И Номенклатура В
			|					(ВЫБРАТЬ
			|						РеализацияТоваровИУслугТовары.Товар КАК Товар
			|					ИЗ
			|						Документ.РеализацияТоваровИУслуг.Товары КАК РеализацияТоваровИУслугТовары
			|					ГДЕ
			|						РеализацияТоваровИУслугТовары.Ссылка = &Ссылка)) КАК ТоварыНаСкладахОстатки
			|ГДЕ
			|	ТоварыНаСкладахОстатки.КоличествоОстаток < 0";
		
		Запрос.УстановитьПараметр("Склад", Склад);
		Запрос.УстановитьПараметр("Ссылка", Ссылка);
		
		РезультатЗапроса = Запрос.Выполнить(); 
		Если НЕ РезультатЗапроса.Пустой() Тогда
		    Отказ = Истина;
			
			ВыборкаДетальныеЗаписи = РезультатЗапроса.Выбрать();
			
			Пока ВыборкаДетальныеЗаписи.Следующий() Цикл
				Сообщить("Недостаточно товара " + ВыборкаДетальныеЗаписи.Номенклатура + " в количестве " + ВыборкаДетальныеЗаписи.Количество);
			КонецЦикла;
		КонецЕсли;
			
	КонецЕсли;
	Если НЕ Отказ Тогда  
		
		Движения.СебестоимостьТоваров.Записывать = Истина;
		// регистр Продажи 
		Движения.Продажи.Записывать = Истина;
		
		Запрос = Новый Запрос;
		Запрос.Текст = 
			"ВЫБРАТЬ
			|	СебестоимостьТоваровОстатки.Номенклатура КАК Номенклатура,
			|	СебестоимостьТоваровОстатки.СуммаОстаток КАК Сумма,
			|	СебестоимостьТоваровОстатки.КоличествоОстаток КАК Количество
			|ИЗ
			|	РегистрНакопления.СебестоимостьТоваров.Остатки(
			|			&МоментВремени,
			|			Номенклатура В
			|				(ВЫБРАТЬ
			|					РеализацияТоваровИУслугТовары.Товар КАК Товар
			|				ИЗ
			|					Документ.РеализацияТоваровИУслуг.Товары КАК РеализацияТоваровИУслугТовары
			|				ГДЕ
			|					РеализацияТоваровИУслугТовары.Ссылка = &Ссылка)) КАК СебестоимостьТоваровОстатки";
		
		Запрос.УстановитьПараметр("МоментВремени", МоментВремени());
		Запрос.УстановитьПараметр("Ссылка", Ссылка);
		
		РезультатЗапроса = Запрос.Выполнить();
		
		ВыборкаДетальныеЗаписи = РезультатЗапроса.Выбрать();
		
		Пока ВыборкаДетальныеЗаписи.Следующий() Цикл
			Если ВыборкаДетальныеЗаписи.Количество <> 0 Тогда
				СебестоимостьЕдиницы = ВыборкаДетальныеЗаписи.Сумма / ВыборкаДетальныеЗаписи.Количество;
			Иначе
				СебестоимостьЕдиницы = 0;
			КонецЕсли;
			
			Движение = Движения.СебестоимостьТоваров.Добавить();
			Движение.ВидДвижения = ВидДвиженияНакопления.Расход;
			Движение.Период = Дата;  
			
			СтрокаТЧ = Товары.Найти(ВыборкаДетальныеЗаписи.Номенклатура, "Товар");
			
			
			Движение.Номенклатура = ВыборкаДетальныеЗаписи.Номенклатура; 
			Движение.Количество = СтрокаТЧ.Количество;
			СебестоимостьСписания = СебестоимостьЕдиницы * СтрокаТЧ.Количество;
			Движение.Сумма = СебестоимостьСписания;
			
			// Движение по регистру Продажи
			Движение = Движения.Продажи.Добавить();
			Движение.Период = Дата; 
			Движение.Клиент = Клиент;
			Движение.Номенклатура = ТекСтрокаТовары.Товар; 
			Движение.Количество = ТекСтрокаТовары.Количество;
			Движение.Сумма = ТекСтрокаТовары.Сумма; 
			Движение.Себестоимость = СебестоимостьСписания;
			
		КонецЦикла;
		
	КонецЕсли;
	
КонецПроцедуры
- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
Отчёт "Валовая прибыль"
  Задача 
    Создать отчёт, показывающий суммы продажи, валовую прибыль, а втакже рентабельность

  Рентабельность
    Отношение Валовой прибыли к Выручке от реализации
----------------------------------------------------------------------------------------------------------------------------------------------------------------
МебельДомТорг -> Отчёт -> Валовая прибыль -> Подсистемы: Продажи -> Основное -> Открыть схему компановки данных -> Готово -> Добавить набор данных - запрос -> Конструктор запроса -> Регистр накопления -> ПродажиОбороты -> Переносим его в таблицы -> Клиент, Номенклатура, СуммаОборот, СебестоимостьОборот -> Нажимаем на СебестоимостьОборот, на кнопку с карандашом -> Пишем внизу СуммаОборот - СебестоимостьОборот -> ОК

Создадим новое поле, кнопкой добавить -> (ПродажиОбороты.СуммаОборот - ПродажиОбороты.СебестоимостьОборот)/ ПродажиОбороты.СуммаОборот * 100 -> ОК
Объединения/Псевдонимы -> Вместо СуммаОбороты укажем Выручка -> Поле 1 заменим на Валовая прибль -> Поле 2 заменим на рентабельность -> ОК
Ресурсы -> Валовая прибль, выручка, рентабельность переносим в поля
Параметры -> НачалоПериода -> Тип: Дата               
КонецПериода -> Тип: Дата            Выражения: КонецПериода(&КонецПериода."День")
Настройки -> Конструктор настройки и компановки данных -> Список -> Далее -> Поля: Клиент, Номенклатура, ВаловаяПрибль, Выручка, Рентабельность -> Далее -> Клиент -> Ok

НачалаПериода -> Значение: произвольная дата -> Пользовательские настройки элемента -> Включать в пользовательские настройки ставим галочку -> ОК
КонецПериода -> Пользовательские настройки элемента -> Включать в пользовательские настройки ставим галочку -> ОК

Набор данных -> Рентабельность -> Тип значения: число ,длина: 15, точность 2 -> Ok

Ресурсы -> Рентабельность -> Окр(Сумма(ВаловаяПрибыль) / Сумма(Выручка) * 100, 2)
- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
Сложные отчёты

	В одном отчёте информация может быть представлена в различных видах
		Разные размеры
		Разные формы представления

	Задача
		Создать свободный отчёт о продажах

	Вывод данных в виде таблицы
		Кросс-таблицы
----------------------------------------------------------------------------------------------------------------------------------------------------------------
Диаграммы отчётов
	Диаграмма
		Точки и серии
		Для построения диаграммы обязателен ресурс

	Диаграмма "Продажи по клиентам"
		Формирование с помощью конструктора

	Диаграмма "Продажи по клиентам в разрезе номенклатуры"

	Круговая диаграмма "Продажи по товарам"
-----------------------------------------------------------------------------------------------------------------------------------------------------------------
Диаграмма вида график
	Графики обычно строятся в разрезе времени

	Задача
		Сформировать график продаж по дням в разрезе клиентов
-----------------------------------------------------------------------------------------------------------------------------------------------------------------
Заключения 13-го дня
	Обеспечили расчет валовой прибыли и рентабельности
		Опирались на выполненный ранее расчет себестоимости

	Раработали отчёты
		С ресурсами вычисляемыми по сложной формуле
		С различными представлением информации
		Построили диаграммы - гистограмму, круговую диаграмму, график
